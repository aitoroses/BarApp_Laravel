// Generated by CoffeeScript 1.6.1
(function() {

  $(document).ready(function() {
    /* Helper functions
    */

    var Comment, CommentList, CommentListView, CommentView, Wine, commentList, commentListView, wine;
    window.templateEscape = function(str) {
      str = str.replace(/&lt;/g, "<");
      return str = str.replace(/&gt;/g, ">");
    };
    /* Models
    */

    Comment = Backbone.Model.extend({
      defaults: {
        urlRoot: '/laravel/public/API/comments',
        item: 'wines',
        name: 'Lorem',
        rating: 5,
        comment: 'Lorem ipsum dolor sit amet, consectetur adipisicing elit. Explicabo maiores totam animi aliquam rerum quo dicta fugit quae tenetur provident doloribus numquam iure corporis? Architecto dolores molestiae quo incidunt culpa.'
      }
    });
    /* Views
    */

    CommentView = Backbone.View.extend({
      tagName: 'article',
      template: _.template(templateEscape($('#comment-template').html())),
      render: function() {
        var attributes;
        attributes = this.model.toJSON();
        this.$el.html(this.template(attributes));
        return this;
      }
    });
    /* Collection
    */

    CommentList = Backbone.Collection.extend({
      model: Comment,
      type: 'wine',
      identifier: 1,
      url: function() {
        return '/laravel/public/API/comments/' + this.type + '/' + this.identifier;
      },
      setItem: function(type, identifier) {
        this.type = type;
        return this.identifier = identifier;
      }
    });
    CommentListView = Backbone.View.extend({
      initialize: function() {
        this.collection.on('add', this.addOne, this);
        return this.collection.on('reset', this.addAll, this);
      },
      addOne: function(comment) {
        var commentView, ratingRange, star, _i, _j, _len, _ref, _results;
        commentView = new CommentView({
          model: comment
        });
        commentView.render();
        ratingRange = (function() {
          _results = [];
          for (var _i = 1, _ref = parseInt(comment.attributes.rating); 1 <= _ref ? _i <= _ref : _i >= _ref; 1 <= _ref ? _i++ : _i--){ _results.push(_i); }
          return _results;
        }).apply(this);
        for (_j = 0, _len = ratingRange.length; _j < _len; _j++) {
          star = ratingRange[_j];
          commentView.$el.find('.column-one').append('<img src="img/star.png" alt="img">');
        }
        return this.$el.append(commentView.el);
      },
      addAll: function() {
        return this.collection.forEach(this.addOne, this);
      },
      render: function() {
        return this.addAll();
      }
    });
    /* Execution
    */

    Wine = Backbone.Model.extend({
      urlRoot: '/laravel/public/API/wine',
      defaults: {
        name: 'Empty title..',
        description: 'Empty description...',
        rating: 'Empty rating..',
        category: 'Empty category..',
        price: 'Empty price..'
      }
    });
    wine = new Wine({
      id: 1
    });
    wine.on("change", function(model) {
      $('.title').text(model.get('name'));
      return $('.description p').text(model.get('description'));
    });
    wine.fetch();
    commentList = new CommentList();
    commentList.setItem('wine', 1);
    commentListView = new CommentListView({
      collection: commentList
    });
    commentList.fetch();
    $('#comments').append(commentListView.el);
    $.ajax({
      type: 'GET',
      url: '../../API/check',
      success: function(data) {
        return $('#user').val(data.username);
      },
      error: function() {
        $('#footer textarea, #footer .btn , #footer .rating').hide();
        return $('#footer h1').text('Registrate para comentar');
      }
    }, $('.rating div').click(function() {
      $('.rating .active').removeClass('active');
      return $(this).addClass('active');
    }));
    return $('#footer .btn').click(function() {
      if (($('.active').length) > 0 && $('#textarea').val().length > 0) {
        return $.ajax({
          type: 'POST',
          url: '../../API/comments/wine/1',
          data: {
            name: $('#user').val(),
            comment: $('textarea').val(),
            rating: 2
          },
          success: function() {
            var comment;
            comment = new Comment({
              name: $('#user').val(),
              comment: $('textarea').val(),
              rating: $('.active').text()
            });
            commentList.add(comment);
            return $(textarea).val('');
          }
        });
      } else {
        return $('#footer h1').text('Elige una valoraci√≥n');
      }
    });
  });

}).call(this);
